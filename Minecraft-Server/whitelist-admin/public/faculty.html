<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Minecraft Whitelist Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 2rem auto; padding: 0 1rem; }
    .card { border: 1px solid #ddd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
    .row { display:flex; gap:.5rem; align-items:center; }
    input[type=text]{ padding:.6rem .7rem; flex:1; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    button{ padding:.55rem .9rem; cursor:pointer; border-radius:6px; border:1px solid #ccc; background:#111; color:#fff; }
    pre { background:#0b1020; color:#e6eefc; padding:1rem; border-radius:8px; overflow:auto; min-height: 120px; }
    .muted { color:#666; }
  </style>
</head>
<body>
  <h1>Minecraft Whitelist Admin</h1>
  <h2 id="greeting"></h2>

  <div class="card">
    <h3>Whitelisted Players</h3>
    <table id="userTable">
      <thead>
        <tr>
          <th>Email</th>
          <th>Minecraft Username</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <div class="card">
    <h3>RCON Console</h3>
    <p class="muted">Send server commands. Output appears below. Examples: <code>list</code>, <code>whitelist list</code>.</p>
    <div class="row" style="margin-top:.5rem;">
      <input id="rconCmd" type="text" placeholder="Enter RCON command" />
      <button id="btnSend">Send</button>
    </div>
    <pre id="rconOut" aria-live="polite">Ready.</pre>
  </div>

  <script>
    async function api(path, options){
      const res = await fetch(path, { headers:{ "Content-Type":"application/json" }, ...options });
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || "Request failed");
      return data;
    }

    async function loadData() {
      try {
        const me = await api('api/me');
        document.getElementById('greeting').textContent = `Hi, ${me.user.email}`;

        const { users } = await api('api/all-users');
        const tbody = document.querySelector('#userTable tbody');
        tbody.innerHTML = '';
        users.forEach(user => {
          const row = tbody.insertRow();
          row.insertCell().textContent = user.email;
          row.insertCell().textContent = user.minecraft_username;
        });
      } catch (e) {
        document.getElementById('greeting').textContent = 'Could not load data.';
      }
    }

    async function sendRcon(){
      const out = document.getElementById('rconOut');
      const cmdInput = document.getElementById('rconCmd');
      const cmd = cmdInput.value.trim();
      if(!cmd) return;
      out.textContent = `> ${cmd}\nRunning...`;
      try{
        const res = await api('api/rcon', { method:'POST', body: JSON.stringify({ cmd }) });
        out.textContent = `> ${cmd}\n${res.reply || '(no output)'}`;
      }catch(e){
        out.textContent = `> ${cmd}\nError: ${e.message}`;
      }
      cmdInput.select();
    }

    document.getElementById('btnSend').onclick = sendRcon;
    document.getElementById('rconCmd').addEventListener('keydown', (ev) => {
      if(ev.key === 'Enter') { ev.preventDefault(); sendRcon(); }
    });

    loadData();
  </script>
</body>
</html>
